<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 10px 0;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<h1>音频播放测试</h1>

<p>这个页面用于测试音频播放功能，帮助诊断声音不播放的问题。</p>

<h2>1. 基本音频测试</h2>
<button id="playShortAudioBtn">播放短音频 (已验证有效)</button>

<h2>2. 浏览器自动播放策略测试</h2>
<button id="playWithUserActionBtn">点击后播放音频</button>

<h2>3. 动态创建音频元素测试</h2>
<button id="createAndPlayBtn">创建并播放音频 (带控制条)</button>

<h2>4. 使用Web Audio API</h2>
<button id="playWebAudioBtn">使用Web Audio API 播放</button>

<h2>5. 游戏音频数据测试</h2>
<button id="playGameAudioBtn">播放游戏中的音频数据</button>

<h2>6. 音量控制测试</h2>
<button id="testVolumeControlBtn">测试音量控制</button>

<h2>日志输出</h2>
<div id="log"></div>

<script>
    // 日志函数
    function log(message) {
        const logElement = document.getElementById('log');
        logElement.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        logElement.scrollTop = logElement.scrollHeight;
    }

    // 清空日志
    function clearLog() {
        document.getElementById('log').textContent = '';
    }

    // 错误分析函数
    function analyzeError(error) {
        log('--- 错误分析 ---');

        if (error.name === 'NotAllowedError') {
            log('这可能是由于浏览器的自动播放策略限制');
            log('解决方案: 确保在用户交互（如点击按钮）后再播放音频');
        } else if (error.name === 'NotSupportedError') {
            log('浏览器不支持这种音频格式');
            log('解决方案: 尝试使用不同的音频格式');
        } else if (error.name === 'NetworkError') {
            log('网络错误或音频数据无效');
            log('解决方案: 检查音频数据是否正确');
        } else {
            log('未知错误类型: ' + error.name);
            log('建议检查浏览器控制台获取更多信息');
        }
    }

    // 1. 基本音频测试 - 使用已验证有效的短音频
    document.getElementById('playShortAudioBtn').addEventListener('click', function() {
        clearLog();
        log('尝试播放已验证有效的短音频...');

        try {
            // 非常短的MP3音频（已验证有效的base64数据）
            const audio = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gQ29uZXB0IEFydCBTdHVkaW9zAA==');

            // 设置音量为最大
            audio.volume = 1.0;

            // 添加事件监听器
            audio.oncanplaythrough = function() {
                log('音频已加载完成，可以播放');
            };

            audio.onerror = function(e) {
                log('音频加载错误: ' + (e.message || '未知错误'));
            };

            audio.play().then(() => {
                log('音频播放成功！');
                log('如果您没有听到声音，请检查系统音量和浏览器音频设置。');
            }).catch(error => {
                log('音频播放失败: ' + error.name + ': ' + error.message);
                analyzeError(error);
            });
        } catch (e) {
            log('发生异常: ' + e.message);
        }
    });

    // 2. 浏览器自动播放策略测试
    document.getElementById('playWithUserActionBtn').addEventListener('click', function() {
        clearLog();
        log('用户点击后播放音频...');

        try {
            const audio = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gQ29uZXB0IEFydCBTdHVkaW9zAA==');
            audio.volume = 1.0;

            audio.play().then(() => {
                log('音频播放成功！');
                log('这表明在用户交互后可以播放音频。');
            }).catch(error => {
                log('音频播放失败: ' + error.name + ': ' + error.message);
                log('请检查浏览器音频设置和系统音量。');
                analyzeError(error);
            });
        } catch (e) {
            log('发生异常: ' + e.message);
        }
    });

    // 3. 动态创建音频元素测试
    document.getElementById('createAndPlayBtn').addEventListener('click', function() {
        clearLog();
        log('动态创建音频元素并尝试播放...');

        try {
            // 先移除可能存在的测试元素
            const existingElement = document.getElementById('test-audio-element');
            if (existingElement) {
                existingElement.remove();
            }

            const audio = document.createElement('audio');
            audio.id = 'test-audio-element';
            audio.controls = true; // 显示控制条，方便手动测试
            audio.preload = 'auto';
            audio.volume = 1.0;

            audio.src = 'data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gQ29uZXB0IEFydCBTdHVkaW9zAA==';

            document.body.appendChild(audio);

            log('音频元素已添加到页面，您可以尝试使用控制条手动播放');

            // 事件监听器
            audio.onplay = function() {
                log('通过Audio元素播放成功！');
            };

            audio.onerror = function(e) {
                log('Audio元素错误: ' + (e.message || '未知错误'));
            };

            // 尝试自动播放
            audio.play().then(() => {
                log('自动播放尝试成功');
            }).catch(error => {
                log('自动播放尝试失败: ' + error.name + ': ' + error.message);
                log('请尝试使用控制条手动播放');
            });
        } catch (e) {
            log('发生异常: ' + e.message);
        }
    });

    // 4. 使用Web Audio API
    document.getElementById('playWebAudioBtn').addEventListener('click', function() {
        clearLog();
        log('开始测试Web Audio API...');

        try {
            // 创建音频上下文
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            log('AudioContext创建成功，状态: ' + audioContext.state);

            // 检查并恢复可能被暂停的上下文
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    log('AudioContext已恢复');
                    playSoundWithWebAudio(audioContext);
                }).catch(err => {
                    log('恢复AudioContext失败: ' + err.message);
                });
            } else {
                playSoundWithWebAudio(audioContext);
            }
        } catch (e) {
            log('Web Audio API测试失败: ' + e.message);
            log('可能是浏览器不支持Web Audio API，或需要用户交互后才能使用');
        }
    });

    // Web Audio API 播放函数
    function playSoundWithWebAudio(audioContext) {
        try {
            // 创建 oscillator（振荡器）
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            // 连接节点
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // 设置参数
            oscillator.type = 'sine'; // 正弦波
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // 440Hz (A4)
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // 音量

            log('开始播放Web Audio API生成的声音（1秒）...');

            // 播放声音
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1); // 1秒后停止

            // 播放完成事件
            oscillator.onended = function() {
                log('Web Audio API声音播放完成！');
            };

        } catch (e) {
            log('播放Web Audio API声音时出错: ' + e.message);
        }
    }

    // 5. 使用与游戏相同的音频数据
    document.getElementById('playGameAudioBtn').addEventListener('click', function() {
        clearLog();
        log('使用与游戏相同的音频数据进行测试...');

        try {
            // 游戏中使用的base64音频数据
            const audioBase64 = 'SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gQ29uZXB0IEFydCBTdHVkaW9zAA==';

            const audio = new Audio(`data:audio/mpeg;base64,${audioBase64}`);
            audio.volume = 1.0;

            audio.play().then(() => {
                log('音频播放成功！');
            }).catch(error => {
                log('音频播放失败: ' + error.name + ': ' + error.message);
                analyzeError(error);
            });
        } catch (e) {
            log('发生异常: ' + e.message);
        }
    });

    // 6. 测试音量控制
    document.getElementById('testVolumeControlBtn').addEventListener('click', function() {
        clearLog();
        log('开始测试音量控制...');

        try {
            const audio = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gQ29uZXB0IEFydCBTdHVkaW9zAA==');

            // 先设置为低音量
            audio.volume = 0.3;
            log('音量设置为: 30%');

            audio.play().then(() => {
                log('低音量播放成功');

                // 延迟一段时间后增大音量
                setTimeout(() => {
                    audio.volume = 1.0;
                    log('音量已增加到: 100%');
                }, 500);
            }).catch(error => {
                log('音量控制测试失败: ' + error.name + ': ' + error.message);
                analyzeError(error);
            });
        } catch (e) {
            log('发生异常: ' + e.message);
        }
    });

    // 检测浏览器音频支持情况
    function detectAudioSupport() {
        const audio = document.createElement('audio');
        const canPlayMP3 = !!audio.canPlayType && audio.canPlayType('audio/mpeg;').replace(/no/, '');
        const canPlayOGG = !!audio.canPlayType && audio.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/, '');

        log('浏览器音频支持检测结果:');
        log('MP3 支持: ' + (canPlayMP3 ? '是' : '否'));
        log('OGG 支持: ' + (canPlayOGG ? '是' : '否'));

        // 检查Web Audio API支持
        const hasWebAudioAPI = !!(window.AudioContext || window.webkitAudioContext);
        log('Web Audio API 支持: ' + (hasWebAudioAPI ? '是' : '否'));

        // 检查自动播放策略
        log('\n自动播放策略检测:');
        log('现代浏览器通常要求用户交互后才能播放音频。请尝试上述测试按钮。');
        log('\n系统信息:');
        log('用户代理: ' + navigator.userAgent);
    }

    // 页面加载时执行音频支持检测
    window.addEventListener('load', function() {
        log('音频测试页面已加载，开始执行音频支持检测...');
        detectAudioSupport();
    });
</script>
</body>
</html>